<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>Test</title>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.mousewheel.min.js"></script>
    <script src="mousekeyEvent.js"></script>
    <script type="text/javascript">
        var noSupportMessage = "Your browser cannot support WebSocket!";
        var ws;
        var canvas;
        var ctx;
        var urlCreator;
        function wsMessage(e) {
            if (typeof e.data === "string") {
                appendMessage(e.data);

            }
            else if (e.data instanceof ArrayBuffer) {

            } else if (e.data instanceof Blob) {
                showBlob(e.data);
                //blob2canvas(e.data);
            }
        }
        function appendMessage(e) {
            //$('#lastMessage').html(e);
            console.log(e);
        }

        function blob2canvas(blob) {
            var img = new Image();
            img.onload = function () {
                if (canvas.width != img.width)
                    canvas.width = img.width;
                if (canvas.height != img.height)
                    canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            }
            img.src = urlCreator.createObjectURL(blob);// blob;
        }
        function showBlob(blob) {
            //console.log(blob);

            var imageUrl = urlCreator.createObjectURL(blob);
            document.querySelector("#blobImage").src = imageUrl;
            //disconnectWebSocket();
        }
        function connectSocketServer() {
            var support = "MozWebSocket" in window ? 'MozWebSocket' : ("WebSocket" in window ? 'WebSocket' : null);

            if (support == null) {
                appendMessage("* " + noSupportMessage + "<br/>");
                return;
            }
            var host = $('#host').val();
            var port = $("#port").val();
            var hostUrl = "ws://" + host + ':' + port + "/";
            appendMessage("* Connecting to server " + hostUrl + "..<br/>");
            // create a new websocket and connect

            ws = new window[support](hostUrl);

            // when data is comming from the server, this metod is called
            ws.onmessage = function (evt) {
                wsMessage(evt);
            }
            ws.onerror = function (event) {
                console.error("WebSocket error observed:", event);
            };

            // when the connection is established, this method is called
            ws.onopen = function () {
                appendMessage('* Connection open<br/>');
                $('#messageInput').attr("disabled", "");
                $('#sendButton').attr("disabled", "");
                $('#connectButton').attr("disabled", "disabled");
                $('#disconnectButton').attr("disabled", "");
            };

            // when the connection is closed, this method is called
            ws.onclose = function () {
                appendMessage('* Connection closed<br/>');
                $('#messageInput').attr("disabled", "disabled");
                $('#sendButton').attr("disabled", "disabled");
                $('#connectButton').attr("disabled", "");
                $('#disconnectButton').attr("disabled", "disabled");
            }
        }

        function sendMessage() {
            if (ws) {
                var messageBox = document.getElementById('messageInput');
                ws.send(messageBox.value);
                messageBox.value = "";
            }
        }
        function sendEvent(event) {
            var eventJson = JSON.stringify(event);
            sendEventMesage(eventJson)
        }
        function sendEventMesage(eventJson) {
            if (ws) {
                //var messageBox = document.getElementById('messageInput');

                //messageBox.value = "";
                //console.log(eventJson);
                ws.send(eventJson);
            }
        }

        function sendCompactEvent(event) {
            var data = getMouseKeyEventData(event);
            var message = {};
            message.Type = 0;
            message.Payload = data;
            sendEvent(message);
        }



        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function connectWebSocket() {
            connectSocketServer();
        }

        window.onload = function () {
            $('#messageInput').attr("disabled", "disabled");
            $('#sendButton').attr("disabled", "disabled");
            $('#disconnectButton').attr("disabled", "disabled");
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            urlCreator = window.URL || window.webkitURL;
            $(document).mousemove((e) => onMouseMove(e));
            $(document).mousedown((e) => onMouseDown(e));
            $(document).mouseup((e) => onMouseUp(e));
            window.addEventListener("wheel", event => onMouseWheel(event));
            $(document).keydown((e) => onKeyDown(e));
            $(document).keyup((e) => onKeyUp(e));
            $(document).mouseup((e) => onMouseUp(e));
            //$('#canvas').on('oncontextmenu', function (e) {
            //    var evt = new Object({ keyCode: 93 });
            //    stopEvent(e);
            //    keyboardUp(evt);
            //});
            //$('body').on('contextmenu', '#canvas', function (e) { return false; });
            var canvas = document.getElementById("blobImage");
            canvas.oncontextmenu = function (e) {
                stopEvent(e);
            };

        }
        function stopEvent(event) {
            if (event.preventDefault != undefined)
                event.preventDefault();
            if (event.stopPropagation != undefined)
                event.stopPropagation();
        }
        var eventX;
        var eventY;
        function onKeyDown(e) {

            //eventX = e.pageX;
            //eventY = e.pageY;
            $('#keyX').val(e.pageX);
            $('#keyY').val(e.pageY);
            $('#keyEventName').val(e.type);
            //console.log(e);
            sendCompactEvent(e);

        }
        function onKeyUp(e) {
            //eventX = e.pageX;
            //eventY = e.pageY;
            $('#keyX').val(e.pageX);
            $('#keyY').val(e.pageY);
            $('#keyEventName').val(e.type);
            //console.log(e);
            sendCompactEvent(e);
        }
        function onMouseMove(e) {
            eventX = e.pageX;
            eventY = e.pageY;
            $('#mouseX').val(e.pageX);
            $('#mouseY').val(e.pageY);
            $('#mouseEventName').val(e.type);
            //console.log(e);
            sendCompactEvent(e);
        }
        function onMouseDown(e) {
            eventX = e.pageX;
            eventY = e.pageY;
            $('#mouseX').val(e.pageX);
            $('#mouseY').val(e.pageY);
            $('#mouseEventName').val(e.type);

            //console.log(e);
            sendCompactEvent(e);
            if (e.button == 2) {
                e.preventDefault();
                return false;
            }
        }
        function onMouseUp(e) {
            eventX = e.pageX;
            eventY = e.pageY;
            $('#mouseX').val(e.pageX);
            $('#mouseY').val(e.pageY);
            $('#mouseEventName').val(e.type);
            //console.log(e);
            sendCompactEvent(e);
            if (e.button == 2) {
                e.preventDefault();
                return false;
            }
        }
        function onMouseWheel(e) {

            $('#mouseX').val(e.wheelDeltaX);
            $('#mouseY').val(e.wheelDeltaY);
            $('#mouseEventName').val(e.type);
            //console.log(e);
            sendCompactEvent(e);

        }

    </script>
</head>
<body>
    <input type="text" id="host" value="192.168.1.170" /> <input type="text" id="port" value="2012" />
    <input type="button" id="connectButton" value="Connect" onclick="connectWebSocket()" />
    <input type="button" id="disconnectButton" value="Disconnect" onclick="disconnectWebSocket()" />
    <input type="text" id="messageInput" /> <input type="button" id="sendButton" value="Send" onclick="sendMessage()" />
    X: <input type="text" id="mouseX" value="" /> Y: <input type="text" id="mouseY" value="" /> <input type="text" id="mouseEventName" />
    X: <input type="text" id="keyX" value="" /> Y: <input type="text" id="keyX" value="" /> <input type="text" id="keyEventName" />
    <br />
    <div id="lastMessage"></div>
    <img id="blobImage" oncontextmenu="return false;"/>
    <canvas id="canvas" height="500" width="500" oncontextmenu="return false;"></canvas>

</body>
</html>